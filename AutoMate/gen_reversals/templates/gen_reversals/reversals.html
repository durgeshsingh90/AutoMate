<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monaco JSON Grouping Tool</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .container {
      display: flex;
      flex-direction: row;
      height: 100%;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f0f0f0;
    }

    .box {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      color: #fff;
      padding: 10px;
      flex-wrap: wrap;
    }

    .buttons-container {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .buttons-container span {
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button.copied {
      background-color: #28a745 !important;
      color: #fff !important;
    }

    .editor-container {
      flex: 1;
      height: 100%;
    }

    #json-status {
      font-size: 14px;
      display: none;
    }
  </style>

  <!-- Monaco Editor Loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
</head>
<body>
  <div class="container">
    
    <!-- Input Box -->
    <div class="box">
      <div class="header">
        <div>Input (with line numbers)</div>
        <div class="buttons-container">
          <span id="json-status">Status: ‚ùå Invalid JSON</span>
          <button id="toggleThemeBtn" onclick="toggleTheme()">üåô Dark</button>
          <button onclick="cleanData()">Clean Data</button>
        </div>
      </div>
      <div id="input-editor" class="editor-container"></div>
    </div>

    <!-- Output Box -->
    <div class="box">
      <div class="header">
        <div>Output</div>
        <div class="buttons-container">
          <button id="copyBtn" onclick="copyOutput()">Copy Output</button>
          <button onclick="handleAction('400 Reversal')">400 Reversal</button>
          <button onclick="handleAction('401 Reversal')">401 Reversal</button>
          <button onclick="handleAction('420 Reversal')">420 Reversal</button>
          <button onclick="handleAction('Refund')">Refund</button>
        </div>
      </div>
      <div id="output-editor" class="editor-container"></div>
    </div>

  </div>

  <script>
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' } });

    let inputEditor, outputEditor;
    let currentTheme = localStorage.getItem('monacoTheme') || 'vs-dark'; // ‚úÖ Get theme from localStorage or use dark as default

    require(['vs/editor/editor.main'], function () {
      initEditors();
    });

    function initEditors() {
      // Input Editor
      inputEditor = monaco.editor.create(document.getElementById('input-editor'), {
        value: '',
        language: 'json',
        theme: currentTheme,
        automaticLayout: true,
        minimap: { enabled: false }
      });

      // Output Editor (Read-only)
      outputEditor = monaco.editor.create(document.getElementById('output-editor'), {
        value: '',
        language: 'json',
        theme: currentTheme,
        readOnly: true,
        automaticLayout: true,
        minimap: { enabled: false }
      });

      updateThemeButtonIcon();

      // Real-time validation while typing
      inputEditor.onDidChangeModelContent(() => {
        const rawInput = inputEditor.getValue();
        updateJsonStatus(rawInput);
      });

      // Handle paste events (instant validation after paste)
      inputEditor.getDomNode().addEventListener('paste', () => {
        setTimeout(() => {
          const rawInput = inputEditor.getValue();
          updateJsonStatus(rawInput);
        }, 10);
      });
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'vs-light' ? 'vs-dark' : 'vs-light';
      monaco.editor.setTheme(currentTheme);
      localStorage.setItem('monacoTheme', currentTheme); // ‚úÖ Save preference
      updateThemeButtonIcon();
    }

    function updateThemeButtonIcon() {
      const btn = document.getElementById('toggleThemeBtn');
      if (currentTheme === 'vs-dark') {
        btn.innerText = 'üåô Dark';
      } else {
        btn.innerText = 'üåû Light';
      }
    }

    function updateJsonStatus(text) {
      const model = inputEditor.getModel();
      const statusElement = document.getElementById('json-status');

      if (text.trim() === '') {
        statusElement.style.display = 'none';
        monaco.editor.setModelMarkers(model, 'json', []);
        return;
      }

      statusElement.style.display = 'inline-block';

      try {
        JSON.parse(text);
        monaco.editor.setModelMarkers(model, 'json', []);
        statusElement.innerText = "Status: ‚úÖ Valid JSON";
        statusElement.style.color = "limegreen";
      } catch (error) {
        monaco.editor.setModelMarkers(model, 'json', [{
          startLineNumber: 1,
          startColumn: 1,
          endLineNumber: 1,
          endColumn: 1,
          message: "Invalid JSON: " + error.message,
          severity: monaco.MarkerSeverity.Error
        }]);
        statusElement.innerText = "Status: ‚ùå Invalid JSON";
        statusElement.style.color = "red";
      }
    }

    function cleanData() {
      const rawText = inputEditor.getValue();
      const cleanedJsonBlocks = extractJsonBlocks(rawText);

      if (cleanedJsonBlocks.length === 0) {
        alert("‚ùå No JSON blocks found.");
        inputEditor.setValue("");
        updateJsonStatus("");
        return;
      }

      const jsonObjects = cleanedJsonBlocks.map(jsonStr => {
        try {
          return JSON.parse(jsonStr);
        } catch (e) {
          console.warn("Skipped invalid JSON block during parsing:", jsonStr);
          return null;
        }
      }).filter(obj => obj !== null);

      const requests100 = [];
      const responses110 = [];

      jsonObjects.forEach(obj => {
        const mti = obj.mti;
        const de037 = obj?.d0t0_elements?.DE037 || obj?.d0t0_elements?.DE037?.trim();

        if (!de037) {
          console.warn("Skipped message without DE037:", obj);
          return;
        }

        if (mti === 100 || mti === "100") {
          requests100.push({ rrn: de037, message: obj });
        } else if (mti === 110 || mti === "110") {
          responses110.push({ rrn: de037, message: obj });
        }
      });

      const groupedMessages = [];

      requests100.forEach((request, index) => {
        const rrn = request.rrn;
        const matchingResponse = responses110.find(response => response.rrn === rrn);

        const pair = {};
        pair[`request${index + 1}`] = request.message;
        pair[`response${index + 1}`] = matchingResponse ? matchingResponse.message : null;

        groupedMessages.push(pair);
      });

      const finalJsonString = JSON.stringify(groupedMessages, null, 4);

      inputEditor.setValue(finalJsonString);
      updateJsonStatus(finalJsonString);
    }

    function copyOutput() {
      const copyBtn = document.getElementById('copyBtn');
      const outputText = outputEditor.getValue();

      navigator.clipboard.writeText(outputText)
        .then(() => {
          copyBtn.innerText = "Copied!";
          copyBtn.classList.add("copied");

          setTimeout(() => {
            copyBtn.innerText = "Copy Output";
            copyBtn.classList.remove("copied");
          }, 1000);
        })
        .catch(err => {
          console.error('‚ùå Failed to copy:', err);
        });
    }

    function handleAction(actionName) {
      console.log(`${actionName} button clicked!`);

      const outputText = outputEditor.getValue();
      const updatedOutput = `${actionName} action triggered!\n\n` + outputText;

      outputEditor.setValue(updatedOutput);
    }

    function extractJsonBlocks(text) {
      const blocks = [];
      let braceCount = 0;
      let startIndex = -1;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];

        if (char === '{') {
          if (braceCount === 0) {
            startIndex = i;
          }
          braceCount++;
        } else if (char === '}') {
          braceCount--;
          if (braceCount === 0 && startIndex !== -1) {
            const jsonBlock = text.slice(startIndex, i + 1);
            try {
              JSON.parse(jsonBlock);
              blocks.push(jsonBlock);
            } catch (e) {
              console.warn("Skipped invalid JSON block:", jsonBlock);
            }
            startIndex = -1;
          }
        }
      }

      return blocks;
    }
  </script>
</body>
</html>
