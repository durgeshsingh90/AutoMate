<!DOCTYPE html>
<html>
<head>
    <title>Project Information Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            width: 300px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .multi-select, .checkboxes {
            margin-bottom: 10px;
        }
        .checkboxes label {
            display: block;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
</head>
<body>

    <h2>Project Information Form</h2>
    <form id="projectForm">
        {% csrf_token %}
        <label for="projectName">Project Name:</label>
        <input type="text" id="projectName" name="projectName" required>

        <label for="projectID">Project ID:</label>
        <input type="text" id="projectID" name="projectID">

        <label for="psp">PSP Name:</label>
        <select id="psp" name="psp" required>
            <!-- Options will be loaded here -->
        </select>

        <label for="owner">Owner:</label>
        <select id="owner" name="owner" required>
            <!-- Options will be loaded here -->
        </select>

        <label for="server">Server:</label>
        <select id="server" name="server" required>
            <!-- Options will be loaded here -->
        </select>

        <label for="schemeType">Scheme Type:</label>
        <div class="multi-select">
            <select id="schemeType" name="schemeType" multiple required>
                <!-- Options will be loaded here -->
            </select>
        </div>

        <label for="simulator">Simulator:</label>
        <select id="simulator" name="simulator" required>
            <!-- Options will be loaded here -->
        </select>

        <label for="dateRange">Date Range:</label>
        <input type="text" id="dateRange" name="dateRange" placeholder="DD/MM/YYYY to DD/MM/YYYY" required>

        <label for="timeSlot">Time Slot:</label>
        <div class="checkboxes" required>
            <label><input type="checkbox" name="timeSlot" value="morning"> Morning</label>
            <label><input type="checkbox" name="timeSlot" value="afternoon"> Afternoon</label>
            <label><input type="checkbox" name="timeSlot" value="overnight"> Overnight</label>
        </div>

        <label for="openSlot">Open Slot (optional):</label>
        <input type="checkbox" id="openSlot" name="openSlot">

        <label for="comments">Comments (optional):</label>
        <input type="text" id="comments" name="comments">

        <br>
        <button type="button" id="submitButton" onclick="submitForm()">Submit</button>
        <div id="submissionMessage"></div>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadConfig();

            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                altInput: true,
                altFormat: "d/m/Y",
                allowInput: true
            });
        });

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function loadConfig() {
            fetch('/slot_booking/config.json')
                .then(response => response.json())
                .then(config => {
                    populateSelect('psp', config.psps, false, false, false, false, false, true);
                    populateSelect('owner', config.owners, false, true);
                    populateSelect('server', config.servers, false, false, true);
                    populateSelect('schemeType', config.schemeTypes, true, false, false, true);
                    populateSelect('simulator', config.simulators, false, false, false, false, true);
                });
        }

        function populateSelect(elementId, options, isMultiple = false, isOwner = false, isServer = false, isSchemeType = false, isSimulator = false, isPSP = false) {
            const selectElement = document.getElementById(elementId);
            selectElement.innerHTML = "";
            options.forEach(option => {
                const opt = document.createElement('option');
                if (isOwner) {
                    opt.value = JSON.stringify(option); // Store as JSON string to parse later
                    opt.text = `${option.name} (${option.lanID})`;
                } else if (isServer) {
                    opt.value = JSON.stringify(option); // Store as JSON string to parse later
                    opt.text = `${option.hostname} (${option.user})`;
                } else if (isSchemeType) {
                    opt.value = option.name;
                    opt.text = option.name;
                } else if (isSimulator) {
                    opt.value = JSON.stringify(option); // Store as JSON string to parse later
                    opt.text = `${option.name} (${option.ipAddress})`;
                } else if (isPSP) {
                    opt.value = JSON.stringify(option); // Store as JSON string to parse later
                    opt.text = `${option.name} (${option.pspID})`;
                } else {
                    opt.value = option;
                    opt.text = option;
                }
                selectElement.add(opt);
            });
        }

        function validateForm() {
            const projectName = document.getElementById('projectName').value;
            const pspName = document.getElementById('psp').value;
            const owner = document.getElementById('owner').value;
            const server = document.getElementById('server').value;
            const schemeType = document.getElementById('schemeType').selectedOptions.length;
            const simulator = document.getElementById('simulator').value;
            const dateRange = document.getElementById('dateRange').value;
            const timeSlots = document.querySelectorAll('input[name="timeSlot"]:checked').length;

            if (!projectName || !pspName || !owner || !server || !schemeType || !simulator || !dateRange || !timeSlots) {
                document.getElementById('submissionMessage').textContent = 'Please fill out all required fields';
                document.getElementById('submissionMessage').style.color = 'red';
                return false;
            }
            return true;
        }

        function submitForm() {
            const formValid = validateForm();
            if (!formValid) {
                return;
            }

            const form = document.getElementById('projectForm');
            const formData = new FormData(form);
            const dateRange = formData.get('dateRange');
            const dateRangeArray = dateRange ? dateRange.split(" to ") : [];
            const csrfToken = getCSRFToken();
            const pspDetails = JSON.parse(formData.get('psp'));
            const ownerDetails = JSON.parse(formData.get('owner'));
            const serverDetails = JSON.parse(formData.get('server'));
            const simulatorDetails = JSON.parse(formData.get('simulator'));

            const jsonData = {
                projectName: formData.get('projectName'),
                projectID: formData.get('projectID') || "",
                psp: pspDetails,
                comments: formData.get('comments') || "",
                owner: ownerDetails,
                server: serverDetails,
                schemeType: formData.getAll('schemeType'),
                simulator: simulatorDetails,
                dateRange: {
                    start: dateRangeArray[0] || "",
                    end: dateRangeArray[1] || ""
                },
                timeSlot: formData.getAll('timeSlot'),
                openSlot: formData.has('openSlot')
            };

            fetch('/slot_booking/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(jsonData)
            }).then(response => {
                const submitButton = document.getElementById('submitButton');
                if (response.ok) {
                    submitButton.textContent = 'Booked';
                    submitButton.style.backgroundColor = 'green';
                    document.getElementById('submissionMessage').textContent = 'Submission saved successfully!';
                    document.getElementById('submissionMessage').style.color = 'green';
                    setTimeout(() => {
                        submitButton.textContent = 'Submit';
                        submitButton.style.backgroundColor = '';
                        document.getElementById('projectForm').reset(); // Reset the form
                    }, 1000);
                } else {
                    response.json().then(data => {
                        document.getElementById('submissionMessage').textContent = `Error: ${data.error}`;
                        document.getElementById('submissionMessage').style.color = 'red';
                        submitButton.textContent = 'Error';
                        submitButton.style.backgroundColor = 'red';
                        setTimeout(() => {
                            submitButton.textContent = 'Submit';
                            submitButton.style.backgroundColor = '';
                        }, 1000);
                    });
                }
            }).catch(error => {
                const submitButton = document.getElementById('submitButton');
                document.getElementById('submissionMessage').textContent = `Error: ${error.message}`;
                document.getElementById('submissionMessage').style.color = 'red';
                submitButton.textContent = 'Error';
                submitButton.style.backgroundColor = 'red';
                setTimeout(() => {
                    submitButton.textContent = 'Submit';
                    submitButton.style.backgroundColor = '';
                }, 1000);
            });
        }
    </script>

</body>
</html>
